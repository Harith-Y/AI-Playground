# ====================================
# AI Playground - Production Docker Compose Override
# ====================================
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.production.yml up -d
#
# This file overrides the base docker-compose.yml with production configurations
# Make sure to configure .env.docker.production before running
# ====================================

services:
  # Redis Cache & Message Broker
  redis:
    restart: always
    command: redis-server /usr/local/etc/redis/redis.conf --requirepass ${REDIS_PASSWORD}
    deploy:
      resources:
        limits:
          cpus: '${REDIS_CPU_LIMIT:-1}'
          memory: ${REDIS_MEM_LIMIT:-1g}
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: ${HEALTH_CHECK_INTERVAL:-30s}
      timeout: ${HEALTH_CHECK_TIMEOUT:-10s}
      retries: ${HEALTH_CHECK_RETRIES:-5}

  # FastAPI Backend
  backend:
    restart: always
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL}
      DB_POOL_SIZE: ${DB_POOL_SIZE:-20}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW:-30}
      DB_POOL_RECYCLE: ${DB_POOL_RECYCLE:-3600}

      # Redis
      REDIS_URL: ${REDIS_URL}
      REDIS_MAX_CONNECTIONS: ${REDIS_MAX_CONNECTIONS:-50}

      # Celery
      CELERY_BROKER_URL: ${CELERY_BROKER_URL}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND}
      CELERY_TASK_TIME_LIMIT: ${CELERY_TASK_TIME_LIMIT:-3600}

      # API Settings
      API_V1_PREFIX: ${API_V1_PREFIX}
      PROJECT_NAME: ${APP_NAME:-AI Playground}
      VERSION: ${APP_VERSION:-1.0.0}
      CORS_ORIGINS: ${CORS_ORIGINS}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS}

      # Security
      SECRET_KEY: ${SECRET_KEY}
      JWT_SECRET: ${JWT_SECRET}
      ALGORITHM: ${ALGORITHM}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES}
      REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-30}
      SECURE_SSL_REDIRECT: ${SECURE_SSL_REDIRECT:-True}
      SESSION_COOKIE_SECURE: ${SESSION_COOKIE_SECURE:-True}
      CSRF_COOKIE_SECURE: ${CSRF_COOKIE_SECURE:-True}

      # File Storage
      UPLOAD_DIR: ${UPLOAD_DIR}
      MAX_UPLOAD_SIZE: ${MAX_UPLOAD_SIZE}
      MAX_UPLOAD_SIZE_MB: ${MAX_UPLOAD_SIZE_MB:-10}
      ALLOWED_EXTENSIONS: ${ALLOWED_EXTENSIONS}

      # Cloudflare R2
      R2_ACCOUNT_ID: ${R2_ACCOUNT_ID}
      R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID}
      R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY}
      R2_BUCKET_NAME: ${R2_BUCKET_NAME}
      R2_PUBLIC_URL: ${R2_PUBLIC_URL}

      # Environment
      ENVIRONMENT: ${ENVIRONMENT}
      DEBUG: ${DEBUG}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_DIR: ${LOG_DIR:-/var/log/ai-playground}
      LOG_FILE: ${LOG_FILE}

      # Rate Limiting
      RATE_LIMIT_PER_MINUTE: ${RATE_LIMIT_PER_MINUTE:-60}
      ENABLE_RATE_LIMITING: ${ENABLE_RATE_LIMITING:-True}

      # Monitoring
      ENABLE_METRICS: ${ENABLE_METRICS:-True}
      METRICS_PORT: ${METRICS_PORT:-9090}
      SENTRY_DSN: ${SENTRY_DSN}
      SENTRY_ENVIRONMENT: ${SENTRY_ENVIRONMENT:-production}
      SENTRY_TRACES_SAMPLE_RATE: ${SENTRY_TRACES_SAMPLE_RATE:-0.1}

      # Feature Flags
      ENABLE_WEBSOCKETS: ${ENABLE_WEBSOCKETS:-True}
      USE_CELERY: ${USE_CELERY:-false}
      USE_BACKGROUND_TASKS: ${USE_BACKGROUND_TASKS:-true}
      ENABLE_EMAIL: ${ENABLE_EMAIL:-false}
      ENABLE_CACHING: ${ENABLE_CACHING:-True}
      ENABLE_HEAVY_MODELS: ${ENABLE_HEAVY_MODELS:-false}
      ENABLE_HYPERPARAMETER_TUNING: ${ENABLE_HYPERPARAMETER_TUNING:-false}
      ENABLE_DEEP_LEARNING: ${ENABLE_DEEP_LEARNING:-false}
      ENABLE_AUTO_ML: ${ENABLE_AUTO_ML:-false}

      # Email (Optional)
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_TLS: ${SMTP_TLS}
      EMAIL_FROM: ${EMAIL_FROM}

      # Free Tier Limits
      MAX_DATASET_ROWS: ${MAX_DATASET_ROWS:-10000}
      MAX_TRAINING_TIME_SECONDS: ${MAX_TRAINING_TIME_SECONDS:-60}
      MAX_CONCURRENT_JOBS: ${MAX_CONCURRENT_JOBS:-2}
      AVAILABLE_MODELS: ${AVAILABLE_MODELS}
    volumes:
      # Remove local code mount in production, use baked-in code
      - backend_uploads:/app/uploads
      - backend_logs:${LOG_DIR:-/var/log/ai-playground}
    deploy:
      resources:
        limits:
          cpus: '${BACKEND_CPU_LIMIT:-4}'
          memory: ${BACKEND_MEM_LIMIT:-4g}
      replicas: 1
    healthcheck:
      interval: ${HEALTH_CHECK_INTERVAL:-30s}
      timeout: ${HEALTH_CHECK_TIMEOUT:-10s}
      retries: ${HEALTH_CHECK_RETRIES:-5}
      start_period: 40s
    command: >
      sh -c "
        echo 'Waiting for database...' &&
        sleep 5 &&
        echo 'Running database migrations...' &&
        alembic upgrade head &&
        echo 'Starting FastAPI server...' &&
        uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers ${BACKEND_WORKERS:-8}
      "

  # Celery Worker
  celery-worker:
    restart: always
    environment:
      # Database
      DATABASE_URL: ${DATABASE_URL}
      DB_POOL_SIZE: ${DB_POOL_SIZE:-20}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW:-30}

      # Redis
      REDIS_URL: ${REDIS_URL}

      # Celery
      CELERY_BROKER_URL: ${CELERY_BROKER_URL}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND}
      CELERY_WORKER_CONCURRENCY: ${CELERY_WORKER_CONCURRENCY:-8}
      CELERY_TASK_TIME_LIMIT: ${CELERY_TASK_TIME_LIMIT:-3600}

      # API Settings
      API_V1_PREFIX: ${API_V1_PREFIX}
      PROJECT_NAME: ${APP_NAME:-AI Playground}
      VERSION: ${APP_VERSION:-1.0.0}

      # Security
      SECRET_KEY: ${SECRET_KEY}
      JWT_SECRET: ${JWT_SECRET}
      ALGORITHM: ${ALGORITHM}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES}

      # File Storage
      UPLOAD_DIR: ${UPLOAD_DIR}
      MAX_UPLOAD_SIZE: ${MAX_UPLOAD_SIZE}

      # Environment
      ENVIRONMENT: ${ENVIRONMENT}
      DEBUG: ${DEBUG}

      # Logging
      LOG_LEVEL: ${CELERY_WORKER_LOGLEVEL:-WARNING}
      LOG_DIR: ${LOG_DIR:-/var/log/ai-playground}

      # Feature Flags
      ENABLE_HEAVY_MODELS: ${ENABLE_HEAVY_MODELS:-false}
      MAX_DATASET_ROWS: ${MAX_DATASET_ROWS:-10000}
      MAX_TRAINING_TIME_SECONDS: ${MAX_TRAINING_TIME_SECONDS:-60}
    volumes:
      # Remove local code mount in production
      - backend_uploads:/app/uploads
      - backend_logs:${LOG_DIR:-/var/log/ai-playground}
    deploy:
      resources:
        limits:
          cpus: '${CELERY_CPU_LIMIT:-4}'
          memory: ${CELERY_MEM_LIMIT:-4g}
      replicas: 1
    command: celery -A celery_worker.celery_app worker --loglevel=${CELERY_WORKER_LOGLEVEL:-WARNING} --concurrency=${CELERY_WORKER_CONCURRENCY:-8}

  # React Frontend
  frontend:
    restart: always
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: production
      args:
        - VITE_API_URL=${VITE_API_URL}
        - VITE_WS_URL=${VITE_WS_URL}
        - VITE_API_TIMEOUT=${VITE_API_TIMEOUT:-60000}
        - VITE_ENV=${VITE_ENV:-production}
        - VITE_ENVIRONMENT=${VITE_ENVIRONMENT:-production}
        - VITE_DEBUG=${VITE_DEBUG:-false}
        - VITE_APP_NAME=${VITE_APP_NAME:-AI Playground}
        - VITE_APP_VERSION=${VITE_APP_VERSION:-1.0.0}
        - VITE_ENABLE_WEBSOCKETS=${VITE_ENABLE_WEBSOCKETS:-true}
        - VITE_ENABLE_ANALYTICS=${VITE_ENABLE_ANALYTICS:-false}
        - VITE_MAX_UPLOAD_SIZE_MB=${VITE_MAX_UPLOAD_SIZE_MB:-10}
        - VITE_MAX_DATASET_ROWS=${VITE_MAX_DATASET_ROWS:-10000}
        - VITE_ENABLE_HEAVY_MODELS=${VITE_ENABLE_HEAVY_MODELS:-false}
        - VITE_ENABLE_HYPERPARAMETER_TUNING=${VITE_ENABLE_HYPERPARAMETER_TUNING:-false}
        - VITE_CSP_ENABLED=${VITE_CSP_ENABLED:-true}
        - VITE_FORCE_HTTPS=${VITE_FORCE_HTTPS:-true}
    deploy:
      resources:
        limits:
          cpus: '${FRONTEND_CPU_LIMIT:-2}'
          memory: ${FRONTEND_MEM_LIMIT:-1g}
      replicas: 1
    healthcheck:
      interval: ${HEALTH_CHECK_INTERVAL:-30s}
      timeout: ${HEALTH_CHECK_TIMEOUT:-10s}
      retries: ${HEALTH_CHECK_RETRIES:-5}
      start_period: 40s

# Named Volumes
volumes:
  redis_data:
    driver: local
  backend_uploads:
    driver: local
  backend_logs:
    driver: local

# Networks
networks:
  aiplayground-network:
    name: ${NETWORK_NAME:-ai-playground-prod-network}
    driver: bridge
