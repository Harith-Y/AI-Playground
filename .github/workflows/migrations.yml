name: Database Migrations

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'backend/alembic/**'
      - 'backend/app/models/**'
      - 'backend/app/db/**'
      - '.github/workflows/migrations.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'backend/alembic/**'
      - 'backend/app/models/**'
      - 'backend/app/db/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  check-migrations:
    name: Check Migration Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install alembic
      
      - name: Lint migration scripts
        working-directory: ./backend
        run: |
          # Check for syntax errors in migration scripts
          python -m py_compile alembic/versions/*.py || true
          echo "✓ Migration scripts syntax check passed"
      
      - name: Validate migration chain
        working-directory: ./backend
        run: |
          # Ensure migration chain is valid
          python -c "from alembic.config import Config; from alembic.script import ScriptDirectory; cfg = Config('alembic.ini'); script = ScriptDirectory.from_config(cfg); head = script.get_current_head(); print(f'Head revision: {head}')"
          echo "✓ Migration chain validated"

  test-migrations:
    name: Test Migrations (PostgreSQL)
    runs-on: ubuntu-latest
    needs: check-migrations
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Wait for PostgreSQL
        run: |
          echo "Waiting for PostgreSQL to be ready..."
          for i in {1..30}; do
            pg_isready -h localhost -p 5432 -U test_user && break
            echo "Attempt $i: PostgreSQL not ready yet..."
            sleep 2
          done
      
      - name: Run migrations (upgrade)
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          MIGRATION_WAIT_TIMEOUT: 30
          MIGRATION_FAIL_ON_ERROR: true
        run: |
          echo "Running database migrations..."
          python scripts/run_migrations.py
          echo "✓ Migrations applied successfully"
      
      - name: Verify migration status
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          echo "Checking migration status..."
          python -c "from app.db.migration_manager import MigrationManager; m = MigrationManager(); status = m.get_migration_status(); print(f'Current: {status[\"current_revision\"]}'); print(f'Head: {status[\"head_revision\"]}'); assert status['is_up_to_date'], 'Database not up to date!'"
          echo "✓ Database is up to date"
      
      - name: Test migration rollback
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          echo "Testing migration rollback..."
          python -c "from app.db.migration_manager import MigrationManager; m = MigrationManager(); m.downgrade('-1')"
          echo "✓ Rollback successful"
      
      - name: Re-apply migrations
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          echo "Re-applying migrations..."
          python scripts/run_migrations.py
          echo "✓ Migrations re-applied successfully"

  deploy-staging-migrations:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: test-migrations
    if: github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'
    environment: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run staging migrations
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          MIGRATION_WAIT_TIMEOUT: 60
          MIGRATION_FAIL_ON_ERROR: true
        run: |
          echo "Running migrations on staging database..."
          python scripts/run_migrations.py
          echo "✓ Staging migrations completed"
      
      - name: Notify success
        if: success()
        run: |
          echo "✓ Staging migrations deployed successfully"
          # Add notification to Slack/Discord/etc. here

  deploy-production-migrations:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test-migrations
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create database backup
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
        run: |
          echo "Creating production database backup..."
          # Add backup command here based on your database
          echo "✓ Backup created (placeholder)"
      
      - name: Run production migrations
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          MIGRATION_WAIT_TIMEOUT: 120
          MIGRATION_FAIL_ON_ERROR: true
        run: |
          echo "Running migrations on production database..."
          python scripts/run_migrations.py
          echo "✓ Production migrations completed"
      
      - name: Verify production status
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
        run: |
          python -c "from app.db.migration_manager import MigrationManager; m = MigrationManager(); status = m.get_migration_status(); print(f'✓ Production database at revision: {status[\"current_revision\"]}')"
      
      - name: Notify success
        if: success()
        run: |
          echo "✓ Production migrations deployed successfully"
          # Add notification to Slack/Discord/etc. here
      
      - name: Notify failure
        if: failure()
        run: |
          echo "✗ Production migrations failed!"
          # Add alert notification here
