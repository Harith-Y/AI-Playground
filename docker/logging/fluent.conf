# Fluentd configuration for AI Playground
#
# Collects logs from Docker containers and forwards to:
# - Elasticsearch
# - Loki
# - S3
# - File storage
#
# Usage with Docker:
#   docker run -d -p 24224:24224 -v $(pwd)/fluent.conf:/fluentd/etc/fluent.conf fluent/fluentd

# Input: Docker logs
<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

# Input: Tail application logs
<source>
  @type tail
  path /var/log/aiplayground/*.log
  pos_file /var/log/aiplayground/fluentd.pos
  tag aiplayground.*
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%LZ
  </parse>
</source>

# Filter: Add common fields
<filter aiplayground.**>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    app_name "ai-playground"
    environment "#{ENV['ENVIRONMENT'] || 'development'}"
  </record>
</filter>

# Filter: Parse JSON logs
<filter **>
  @type parser
  key_name log
  reserve_data true
  <parse>
    @type json
  </parse>
</filter>

# Output: Elasticsearch
<match aiplayground.**>
  @type elasticsearch
  host "#{ENV['ELASTICSEARCH_HOST'] || 'elasticsearch'}"
  port "#{ENV['ELASTICSEARCH_PORT'] || 9200}"
  index_name aiplayground
  logstash_format true
  logstash_prefix aiplayground
  logstash_dateformat %Y.%m.%d
  include_tag_key true
  tag_key @log_name
  <buffer>
    @type file
    path /var/log/fluentd/buffer/elasticsearch
    flush_interval 10s
    retry_max_times 3
  </buffer>
</match>

# Output: Grafana Loki
<match aiplayground.**>
  @type loki
  url "#{ENV['LOKI_URL'] || 'http://loki:3100'}"
  username "#{ENV['LOKI_USERNAME'] || ''}"
  password "#{ENV['LOKI_PASSWORD'] || ''}"
  extra_labels {"environment":"#{ENV['ENVIRONMENT'] || 'development'}","app":"ai-playground"}
  <label>
    level
    logger
    environment
  </label>
  <buffer>
    @type file
    path /var/log/fluentd/buffer/loki
    flush_interval 10s
  </buffer>
</match>

# Output: S3 (for long-term storage)
<match aiplayground.**>
  @type s3
  aws_key_id "#{ENV['AWS_ACCESS_KEY_ID']}"
  aws_sec_key "#{ENV['AWS_SECRET_ACCESS_KEY']}"
  s3_bucket "#{ENV['S3_LOG_BUCKET'] || 'aiplayground-logs'}"
  s3_region "#{ENV['AWS_REGION'] || 'us-east-1'}"
  path logs/%Y/%m/%d/
  <buffer time>
    @type file
    path /var/log/fluentd/buffer/s3
    timekey 3600  # 1 hour
    timekey_wait 10m
    chunk_limit_size 256m
  </buffer>
  <format>
    @type json
  </format>
</match>

# Output: File backup (local)
<match aiplayground.**>
  @type file
  path /var/log/aiplayground/backup/${tag}/%Y/%m/%d/log
  <buffer tag,time>
    @type file
    path /var/log/fluentd/buffer/file
    timekey 86400  # 1 day
    timekey_wait 10m
  </buffer>
  <format>
    @type json
  </format>
</match>
